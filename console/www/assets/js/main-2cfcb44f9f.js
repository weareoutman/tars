$.fn.selectRange=function(e,t){return t||(t=e),this.each(function(){if(this.setSelectionRange)this.focus(),this.setSelectionRange(e,t);else if(this.createTextRange){var n=this.createTextRange();n.collapse(!0),n.moveEnd("character",t),n.moveStart("character",e),n.select()}})},angular.module("tars",["ui.router","ngClipboard","ui.codemirror","tars.directives","tars.services","tars.controllers"]).constant("DEBUG",!0).constant("NAVBAR_TASK_INTERVAL",3e4).constant("TASK_DETAIL_INTERVAL",5e3).constant("TASK_DEFAULT_DATE_RANGE","week").constant("PKG_DEFAULT_USER",null).constant("PKG_DEFAULT_FRAMEWORK_TYPE","server").constant("PKG_DEFAULT_VERSION","1.0.0").config(["$httpProvider","ngClipProvider",function(e,t){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",t.setPath("/assets/lib/zeroclipboard/dist/ZeroClipboard.swf"),CodeMirror.modeURL="/assets/lib/codemirror/mode/%N/%N.js"}]).run(["$rootScope","$window","$location","Dialog","Me","console",function(e,t,n,a,r,i){e.$on("$stateChangeError",function(e,t,n,r,o,s){i.error("$stateChangeError",s),0!==s.status&&a.alert({message:"请求错误",level:"error",log:{url:s.config.url,status:s.status+" "+s.statusText,data:s.data}})}),e.$on("$stateChangeSuccess",function(){t.ga&&t.ga("send","pageview",{page:n.path()})}),e.isAdmin="admin"===r.getRole(),e.authByThirdPart=window._auth_by_third_part}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,n){n.html5Mode(!0),e.state("home",{url:"/",templateUrl:"/templates/index.html",controller:"HomeCtrl",resolve:{productList:["PkgManager",function(e){return e.listProducts()}]},onEnter:["$rootScope",function(e){e.isIndex=!0}],onExit:["$rootScope",function(e){e.isIndex=!1}]}).state("search",{url:"/search?q&p",templateUrl:"/templates/search.html",controller:"SearchCtrl",resolve:{resultList:["$stateParams","PkgManager",function(e,t){return t.search(e.q,e.p)}]}}).state("product",{url:"/p/{product:\\w+}",templateUrl:"/templates/product.html",controller:"ProductCtrl",resolve:{pkgList:["$stateParams","PkgManager",function(e,t){return t.search(null,e.product)}]}}).state("tasks",{url:"/task?range&page",views:{"":{templateUrl:"/templates/tasks.html"},"@tasks":{templateUrl:"/templates/tasks-content.html",controller:"TasksCtrl",resolve:{taskData:["$stateParams","TaskManager",function(e,t){return t.list(e.range,e.page)}],pkg:function(){return null}}}}}).state("task-detail",{url:"/task/{taskId:\\w+}",templateUrl:"/templates/task-detail.html",controller:"TaskDetailCtrl",resolve:{taskDetail:["$stateParams","TaskManager",function(e,t){return t.detail(0,e.taskId)}]}}).state("new",{url:"/new?product",views:{"":{templateUrl:"/templates/new.html",controller:"NewCtrl",resolve:{productList:["PkgManager",function(e){return e.listProducts()}],versionDetail:function(){return null},pkgDetail:function(){return null}}},"dialogs@new":{templateUrl:"/templates/new-dialogs.html",controller:"NewDialogsCtrl"},"editor-dialogs@new":{templateUrl:"/templates/editor-dialogs.html",controller:"EditorDialogsCtrl"}}}).state("version-detail",{url:"/p/{product:\\w+}/{name:\\w+}/v{version:[\\d\\.]+}",views:{"":{templateUrl:"/templates/new.html",controller:"NewCtrl",resolve:{productList:["PkgManager",function(e){return e.listProducts()}],versionDetail:["$stateParams","PkgManager",function(e,t){return t.getVersionDetail(e.product,e.name,e.version)}],pkgDetail:function(){return null}}},"dialogs@version-detail":{templateUrl:"/templates/install-dialogs.html",controller:"InstallDialogsCtrl"},"editor-dialogs@version-detail":{templateUrl:"/templates/editor-dialogs.html",controller:"EditorDialogsCtrl"}}}).state("pkg",{"abstract":!0,url:"/p/{product:\\w+}/{name:\\w+}",templateUrl:"/templates/pkg.html",controller:"PkgCtrl",resolve:{pkg:["$stateParams",function(e){return e}]}}).state("pkg.versions",{url:"",views:{"":{templateUrl:"/templates/pkg-versions.html",controller:"PkgVersionsCtrl",resolve:{versionList:["PkgManager","pkg",function(e,t){return e.getVersionList(t.product,t.name)}]}},dialogs2:{templateUrl:"/templates/install-dialogs.html",controller:"InstallDialogsCtrl"}}}).state("pkg.instances",{url:"/instances?version&ips&page&size",views:{"":{templateUrl:"/templates/pkg-instances.html",controller:"PkgInstancesCtrl",resolve:{instanceData:["$stateParams","PkgManager","pkg",function(e,t,n){return t.getInstanceData(n.product,n.name,e)}]}},dialogs:{templateUrl:"/templates/pkg-instances-dialogs.html",controller:"PkgInstancesDialogsCtrl"},dialogs2:{templateUrl:"/templates/install-dialogs.html",controller:"InstallDialogsCtrl"}}}).state("pkg.settings",{url:"/settings",templateUrl:"/templates/pkg-settings.html",controller:"PkgSettingsCtrl",resolve:{settings:["PkgManager","pkg",function(e,t){return e.getSettings(t.product,t.name)}]}}).state("pkg.tasks",{url:"/tasks?range&page",templateUrl:"/templates/tasks-content.html",controller:"TasksCtrl",resolve:{taskData:["$stateParams","TaskManager","pkg",function(e,t,n){return t.list(e.range,e.page,n)}]}}).state("pkg.new",{url:"/new",views:{"@":{templateUrl:"/templates/new.html",controller:"NewCtrl",resolve:{productList:["PkgManager",function(e){return e.listProducts()}],versionDetail:function(){return null},pkgDetail:["PkgManager","pkg",function(e,t){return e.getPkgDetail(t.product,t.name)}]}},"dialogs@pkg.new":{templateUrl:"/templates/new-dialogs.html",controller:"NewDialogsCtrl"},"editor-dialogs@pkg.new":{templateUrl:"/templates/editor-dialogs.html",controller:"EditorDialogsCtrl"}}}).state("users",{url:"/users",templateUrl:"/templates/users.html",controller:"UsersCtrl",resolve:{userList:["UserManager",function(e){return e.list()}]}}).state("devices",{url:"/devices",views:{"":{templateUrl:"/templates/devices.html",controller:"DevicesCtrl",resolve:{deviceList:["DeviceManager",function(e){return e.list()}]}},"dialogs@devices":{templateUrl:"/templates/devices-dialogs.html",controller:"DevicesDialogsCtrl"}}}).state("devices-import",{url:"/devices/import",templateUrl:"/templates/devices-import.html",controller:"DevicesImportCtrl",resolve:{deviceAttrs:["DeviceManager",function(e){return e.listAttrs()}]}}).state("devices-passwords",{url:"/devices/passwords",templateUrl:"/templates/devices-passwords.html",controller:"DevicesPasswordsCtrl"}).state("product-manage",{url:"/p",templateUrl:"/templates/product-manage.html",controller:"ProductManageCtrl",resolve:{productList:["PkgManager",function(e){return e.listProducts()}]}}).state("account",{url:"/account",templateUrl:"/templates/account.html",controller:"AccountCtrl"}),t.otherwise("/")}]),angular.module("tars.directives",[]).controller("PaginationController",["$scope","$attrs","$parse",function(e,t,n){var a=this,r={$setViewValue:angular.noop},i=t.numPages?n(t.numPages).assign:angular.noop;this.init=function(i){r=i,r.$render=function(){a.render()},t.itemsPerPage?e.$parent.$watch(n(t.itemsPerPage),function(t){a.itemsPerPage=parseInt(t,10),e.totalPages=a.calculateTotalPages()}):a.itemsPerPage=20},this.calculateTotalPages=function(){var t=this.itemsPerPage<1?1:Math.ceil(e.totalItems/this.itemsPerPage);return Math.max(t||0,1)},this.render=function(){e.page=parseInt(r.$viewValue,10)||1},e.selectPage=function(t){e.page!==t&&t>0&&t<=e.totalPages&&(r.$setViewValue(t),r.$render())},e.noPrevious=function(){return 1===e.page},e.noNext=function(){return e.page===e.totalPages},e.$watch("totalItems",function(){e.totalPages=a.calculateTotalPages()}),e.$watch("totalPages",function(t){i(e.$parent,t),e.page>t?e.selectPage(t):r.$render()})}]).directive("tarsPagination",function(){return{restrict:"EA",scope:{totalItems:"="},require:["tarsPagination","?ngModel"],controller:"PaginationController",templateUrl:"/templates/pagination.html",replace:!0,link:function(e,t,n,a){var r=a[0],i=a[1];i&&r.init(i)}}}).directive("tooltip",function(){return{restrict:"A",link:function(e,t){$(t).tooltip({animation:!1})}}}).directive("popover",function(){return{restrict:"A",link:function(e,t){$(t).popover({animation:!1})}}}),angular.module("tars.services",[]).factory("Me",function(){return{getUsername:function(){return window._username},getRole:function(){return window._userrole}}}).factory("HttpWrapper",["$q",function(e){function t(t,n){var a=e.defer();return t.then(function(e){var t,r=e.data;switch(n){case"array":t="isArray";break;case"object":t="isObject"}angular[t](r)?a.resolve(r):a.reject({status:e.status,data:{code:1001,httpStatus:200,data:{error:"unexpected result"}}})},a.reject),a.promise}return{array:function(e){return t(e,"array")},object:function(e){return t(e,"object")}}}]).factory("HandleAjaxError",["Dialog","HandleNoSession",function(e,t){return function(n,a){0!==a.status&&(t(a)||e.alert({message:n,level:"error",log:a.data?a.data.data?a.data.data.error||a.data.data:a.data:_.pick(a,"status","data")}))}}]).factory("HandleNoSession",["Dialog",function(e){return function(t){return 403===t.status&&t.data&&"no session"===t.data.error?(e.confirm({message:"你还没有登录或登录信息超时，请重新登录！",level:"warning",confirm:function(){location.href="/signin"}}),!0):!1}}]).factory("console",["DEBUG",function(e){var t=["log","error"],n={},a=window.console;return angular.forEach(t,function(t){n[t]=function(){e&&a&&a[t].apply(a,arguments)}}),n}]).filter("taskVersion",function(){return function(e){if(e.param)switch(e.op_type){case"update":return"v"+e.param.fromVersion+" > v"+e.param.toVersion;case"install":return"v"+e.param.version}return""}}).filter("operationType",function(){var e={install:"安装",update:"升级",rollback:"回滚",start:"启动",restart:"重启",stop:"停止",uninstall:"卸载"};return function(t){return e[t]||"未知"}}).filter("taskStatus",function(){var e={ok:"成功",failed:"失败",wait:"等待"},t=_.defaults({wait:"中..."},e);return function(n,a){return(a?t:e)[n.task_status]||"未知"}}).filter("taskDetailStatus",function(){return function(e){switch(e.status){case"wait":return"等待中";case"started":return"执行中";case"ok":return"成功";case"failed":return"失败";default:return"未知"}}}).filter("taskProgress",function(){return function(e){return e.success_num+"/"+e.task_num}}).filter("svnAction",function(){return function(e){switch(e){case"unversion":case"add":return"新增";case"modify":return"修改";case"delete":case"miss":return"删除";default:return"其它"}}}).filter("costTime",function(){return function(e){e=+e;var t=e%60,n=Math.floor(e/60),a=Math.floor(e/3600);return(a>0?a+"h":"")+(a>0||n>0?n+"′":"")+(a>0||n>0||t>0?t+"″":"")}}).factory("Utils",["$timeout",function(e){return{matchIps:function(e){return e.match(/\b\d{1,3}(\.\d{1,3}){3}\b/g)},copied:function(t){var n=$(t).tooltip({show:!0,trigger:"manual",title:"已复制"}).tooltip("show");e(function(){n.tooltip("hide")},1e3)}}}]).factory("PkgUrl",function(){return{build:function(e,t){return"/api/p/"+e.product+"/"+e.name+(t?"/v"+e.version:"")}}}).factory("PkgManager",["$http","HttpWrapper","PkgUrl",function(e,t,n){var a=t.array(e.get("/api/p"));return{listProducts:function(){return a},storeProducts:function(n){return t.object(e.post("/api/p",n))},removeProducts:function(n){return t.object(e["delete"]("/api/p",{params:{ids:n.join(";")}}))},relistProducts:function(){return a=t.array(e.get("/api/p"))},search:function(n,a){return t.array(e.get("/api/search",{params:{q:n,p:a}}))},getPkgDetail:function(a,r){return t.object(e.get(n.build({product:a,name:r})+"/detail"))},getVersionDetail:function(a,r,i){return t.object(e.get(n.build({product:a,name:r,version:i},!0)+"/detail"))},getVersionList:function(a,r){return t.array(e.get(n.build({product:a,name:r})+"/versions"))},getGreaterVersionList:function(a,r,i){return t.array(e.get(n.build({product:a,name:r,version:i},!0)+"/greater-versions"))},getSettings:function(a,r){return t.object(e.get(n.build({product:a,name:r})+"/settings"))},updateSettings:function(a,r){return t.object(e.put(n.build(a)+"/settings",r))},getInstanceData:function(a,r,i){return t.object(e.get(n.build({product:a,name:r})+"/instances",{params:i}))},updateRemark:function(a){return t.object(e.put(n.build(a,!0)+"/detail",{remark:a.remark}))},install:function(a,r){return t.object(e.post(n.build(a)+"/install",r))},update:function(a,r){return t.object(e.post(n.build(a)+"/update",r))},maintenance:function(a,r,i){return t.object(e.post(n.build(a)+"/maintenance",i,{params:{operation:r}}))},rollback:function(a,r){return t.object(e.post(n.build(a)+"/rollback",r))},exist:function(a){return t.object(e.get(n.build(a)+"/exist"))},create:function(a){return t.object(e.post(n.build(a)+"/create",{frameworkType:a.frameworkType}))},save:function(a,r){return t.object(e.put(n.build(a,!0)+"/config",r))},submit:function(a,r,i){return t.object(e[i?"post":"put"](n.build(a,!0),r))},removeVersion:function(a){return t.object(e["delete"](n.build(a,!0)))}}}]).factory("TaskManager",["$http","HttpWrapper","PkgUrl",function(e,t,n){return{list:function(a,r,i){return t.object(i?e.get(n.build(i)+"/tasks",{params:{range:a,page:r}}):e.get("/api/task",{params:{range:a,page:r}}))},listUnread:function(){return t.array(e.get("/api/task/unread"))},read:function(n){return t.object(e.put("/api/task/read",n))},detail:function(n,a){return t.object(e.get("/api/task/"+a,{timeout:n}))}}}]).factory("FileManager",["$http","HttpWrapper","PkgUrl",function(e,t,n){return{ls:function(a,r,i){return t.array(e.get(n.build(a,!!i)+"/tree/"+r,{params:{home:i}}))},rm:function(a,r){return t.object(e["delete"](n.build(a)+"/blob/"+r))},mkdir:function(a,r){return t.object(e.post(n.build(a)+"/blob/"+r))},rename:function(a,r,i){return t.object(e.put(n.build(a)+"/blob/"+r,{name:i}))},chmod:function(a,r,i){return t.object(e.put(n.build(a)+"/blob/"+r,{mode:i}))},pull:function(a,r,i,o){return t.object(e.post(n.build(a)+"/pull/"+r,{ip:i,fileList:o}))},content:function(a,r,i,o){return t.object(e.get(n.build(a,!!o)+"/blob/"+r,{params:{charset:i,home:o}}))},updateContent:function(a,r,i,o){return t.object(e.put(n.build(a)+"/blob/"+r,{content:i,charset:o}))}}}]).factory("SvnManager",["$http","HttpWrapper","PkgUrl",function(e,t,n){return{status:function(a){return t.array(e.get(n.build(a)+"/svn/status"))},revert:function(a,r){return t.object(e.post(n.build(a)+"/svn/revert",{path:r}))}}}]).factory("UserManager",["$http","HttpWrapper",function(e,t){return{list:function(){return t.array(e.get("/api/users"))},store:function(n){return t.object(e.post("/api/users",n))},update:function(n){return t.object(e.put("/api/user",n))}}}]).factory("DeviceManager",["$http","HttpWrapper",function(e,t){return{list:function(n){return t.array(e.get("/api/devices",{params:n}))},listAttrs:function(){return t.object(e.get("/api/devices/attrs"))},importPasswords:function(n){return t.object(e.post("/api/devices/passwords",n))},importDevices:function(n){return t.object(e.post("/api/devices",n))},removeDevices:function(n){return t.object(e.post("/api/devices/batch?_method=DELETE",n))}}}]).factory("Dialog",["$rootScope",function(e){return{alert:function(t){e.$broadcast("dialog show","alert",t)},confirm:function(t){e.$broadcast("dialog show","confirm",t)},prompt:function(t){e.$broadcast("dialog show","prompt",t)},"delete":function(t){e.$broadcast("dialog show","confirm",_.defaults(t,{confirmText:"删除",confirmClass:"btn-danger",level:"warning"}))},processing:function(){e.$broadcast("dialog processing")},processed:function(){e.$broadcast("dialog processed")},close:function(){e.$broadcast("dialog close")}}}]).controller("DialogCtrl",["$scope","$timeout",function(e,t){var n=$("#modal-dailog"),a={title:"提示",cancelText:"取消",confirmText:"确定",confirmClass:"btn-primary",autofocus:!0,cancel:function(){n.modal("hide")}},r={alert:{confirm:function(){n.modal("hide")}}};e.$on("dialog show",function(i,o,s){e.options=_.defaults(s,a,r[o]),e.type=o,e.processing=!1,n.modal({show:!0,backdrop:"static"}),s.autofocus&&t(function(){"prompt"===o?n.find(".form-control").focus().select():n.find(".js-confirm").focus()})}),e.$on("dialog processing",function(){e.processing=!0}),e.$on("dialog processed",function(){e.processing=!1}),e.$on("dialog close",function(){n.modal("hide")})}]),angular.module("tars.controllers",[]).controller("NavbarCtrl",["$scope","$rootScope","$state","$timeout","TaskManager","PkgManager","Me","HandleAjaxError","HandleNoSession","console","NAVBAR_TASK_INTERVAL",function(e,t,n,a,r,i,o,s,l,c,u){function d(){r.listUnread().then(function(t){e.taskList=t})["catch"](function(e){s("查询未读任务失败！",e)})["finally"](function(){e.taskLoading=!1})}function f(){a(p,u)}function p(){r.listUnread().then(function(t){c.log("TaskManager.listUnread",t),e.taskList=t})["catch"](function(e){c.error("TaskManager.listUnread",e),l(e)})["finally"](f)}function g(){e.loadingProducts=!0,i.listProducts().then(function(t){c.log("PkgManager.listProducts",t),e.productList=t})["catch"](function(e){c.error("PkgManager.listProducts",e)})["finally"](function(){e.loadingProducts=!1})}if(3e3>u)throw"NAVBAR_TASK_INTERVAL should be greater than 3000";e.username=o.getUsername(),e.params={},e.search=function(){return e.params.q&&n.go("search",e.params),!1},e.pkgActive=function(){return n.includes("home")||n.includes("search")||n.includes("product")||n.includes("pkg")},e.devicesActive=function(){return n.includes("devices")||n.includes("devices-import")||n.includes("devices-passwords")};var m;e.myTaskEnter=function(){m&&(a.cancel(m),m=null),e.myTaskOpen=!0},e.myTaskLeave=function(){m=a(function(){e.myTaskOpen=!1},200)},e.closeMyTask=function(){e.myTaskOpen=!1},e.pkgEnter=function(){e.pkgOpen=!0},e.pkgLeave=e.closePkg=function(){e.pkgOpen=!1},e.globalTaskStatus=function(){var t=0,n=0,a=0;return angular.forEach(e.taskList,function(e){switch(e.task_status){case"ok":t+=1;break;case"failed":n+=1;break;case"wait":a+=1}}),a>0?null:n>0?"error":"success"},t.$on("$stateChangeStart",function(){e.progressing=!0}),t.$on("$stateChangeSuccess",function(){e.progressing=!1}),t.$on("$stateChangeError",function(){e.progressing=!1}),e.taskLoading=!0,d(),e.clearTask=function(t,n){r.read([t.task_id]).then(function(){e.taskList.splice(n,1)})["catch"](function(e){s("标记任务已读失败！",e)})},e.clearAllTask=function(){var t=[];angular.forEach(e.taskList,function(e){t.push(e.task_id)}),t.length&&r.read(t).then(function(t){c.log("TaskManager.read",t),e.taskList=[]})["catch"](function(e){s("标记任务已读失败！",e)})},f(),g(),e.$on("relist products",g),e.$on("search destroy",function(){e.params.q=null}),e.$on("search key",function(t,n){e.params.q=n})}]).controller("HomeCtrl",["$scope","$state","productList",function(e,t,n){e.productList=n,e.params={},e.search=function(){!e.params.q&&e.params.p?t.go("product",{product:e.params.p}):(e.params.q||e.params.p)&&t.go("search",e.params)}}]).controller("SearchCtrl",["$scope","$stateParams","resultList",function(e,t,n){var a=!1,r={page:1};e.itemsPerPage=20,e.totalItems=n.length,e.filters=r,e.$watch("filters",function(){var t=(r.page-1)*e.itemsPerPage,i=t+e.itemsPerPage;e.resultList=n.slice(t,i),a?window.scrollTo(0,0):a=!0},!0),e.$parent.$broadcast("search key",t.q),e.$on("$destroy",function(){e.$parent.$broadcast("search destroy")})}]).controller("TasksCtrl",["$scope","$stateParams","$state","taskData","pkg","TASK_DEFAULT_DATE_RANGE",function(e,t,n,a,r,i){function o(e){var t={};return angular.forEach(e,function(e,n){t[n]=s[n]===e?null:e}),t}e.rangeList=[{value:"today",text:"今天"},{value:"yesterday",text:"昨天"},{value:"week",text:"近7天"},{value:"month",text:"近30天"},{value:"all",text:"全部"}];var s={range:i,page:1},l=_.defaults(t,s);e.taskList=a.taskList,e.totalItems=a.total,e.itemsPerPage=20,e.filters=l,e.pkg=r,e.setActiveRange=function(e){l.range=e.value},e.isActiveRange=function(e){return l.range===e.value},e.goToPkgInstances=function(e){n.go("pkg.instances",_.defaults({ips:e.ip_list.replace(/;/g,",")},e))},e.$watch("filters",function(e,t){var a=o(e);angular.equals(a,o(t))||(window.scrollTo(0,0),r?n.go("pkg.tasks",_.defaults(a,r)):n.go("tasks",a))},!0)}]).controller("TaskDetailCtrl",["$scope","$q","$stateParams","$state","$timeout","TaskManager","HandleAjaxError","Utils","taskDetail","TASK_DETAIL_INTERVAL",function(e,t,n,a,r,i,o,s,l,c){function u(t){p={all:[],ok:[],failed:[]},e.taskId=n.taskId,e.taskResult=t.result,e.taskDetail=t.detail,e.ips=p,angular.forEach(t.result,function(e){switch(e.status){case"ok":case"failed":p[e.status].push(e.ip)}p.all.push(e.ip)}),"ok"!==t.detail.task_status&&"failed"!==t.detail.task_status&&d()}function d(){g=r(f,c)}function f(){i.detail(v,e.taskId).then(u)["catch"](function(e){o("查询任务结果失败！",e),0!==e.status&&d()})}if(3e3>c)throw"TASK_DETAIL_INTERVAL should be greater than 3000";var p,g,m=t.defer(),v=m.promise;u(l),e.getIpsToCopy=function(e){return p[e?e:"all"].join("\n")},e.copied=s.copied,e.toggleParam=function(){e.paramShown=!e.paramShown},e.goToPkgInstances=function(){var t=e.taskDetail;a.go("pkg.instances",_.defaults({ips:t.ip_list.replace(/;/g,",")},t))},e.$on("$destroy",function(){r.cancel(g),m.resolve()})}]).controller("NewCtrl",["$scope","$stateParams","$state","$timeout","PkgManager","FileManager","SvnManager","PkgUrl","Dialog","HandleAjaxError","Me","console","productList","pkgDetail","versionDetail","PKG_DEFAULT_USER","PKG_DEFAULT_FRAMEWORK_TYPE","PKG_DEFAULT_VERSION",function(e,t,n,a,r,i,o,s,l,c,u,d,f,p,g,m,v,h){function k(t){r.create(t).then(function(e){d.log("PkgManager.create",e),M()})["catch"](function(e){c("创建包失败！",e)})["finally"](function(){e.startingCreate=!1})}function P(){e.confirmed=!0,w(),y()}function b(e){return(e?R.concat(e):R).join("/")}function w(t){e.lsing=!0,t&&(t.lsing=!0),void 0===e.filesFirstLoading&&(e.filesFirstLoading=!0,L()),i.ls(U,b(),I).then(function(t){d.log("FileManager.ls",t),e.fileList=t})["catch"](function(e){R=S,c("查询文件目录失败！",e)})["finally"](function(){e.lsing=!1,t&&(t.lsing=!1),e.filesFirstLoading=!1})}function L(){e.newVersion&&(e.svnProcessing=!0,o.status(U).then(function(t){d.log("SvnManager.status",t),e.changeList=t})["catch"](function(e){c("查询svn状态失败！",e)})["finally"](function(){e.svnProcessing=!1}))}function y(){i.content(U,"init.xml","gbk",I).then(function(t){d.log("FileManager.content",t),e.xml={content:t.content},e.readonly||e.frameworkTypeChanged();var n=D(t.content);angular.forEach(O,function(t){n.hasOwnProperty(t)&&(e.config[t]=n[t])}),"undefined"!==U.frameworkType||e.config.app_name||(e.config.app_name="null")})["catch"](function(e){c("获取配置文件失败！",e)})}function D(e){for(var t,n=/<(\w+)>([\s\S]*?)<\/\1>/g,a=/^\s*(\w+)="(.*)"/gm,r={},i={};null!==(t=n.exec(e));)r[t[1]]=$.trim(t[2]);if(r.base_info){for(;null!==(t=a.exec(r.base_info));)i[t[1]]=$.trim(t[2]);delete r.base_info}return _.defaults(r,i)}function C(){if(e.xml){var t=e.xml.content,n=_.defaults(e.config,_.pick(U,F)),a=V.concat(F);angular.forEach(n,function(e,n){var r=e.replace(/\$/g,"$$$$");if(-1!==_.indexOf(a,n))"version"===n&&(r=r.replace(/\.\d+$/,"")),t=t.replace(new RegExp("^\\s*"+n+'=".*"',"m"),n+'="'+r+'"');else{var i=new RegExp("<"+n+">(?:[\\s\\S]*?)<\\/"+n+">");i.test(t)?t=t.replace(i,"<"+n+">\n"+r+"\n</"+n+">"):e&&(t+="\n\n<"+n+">\n"+e+"\n</"+n+">")}}),e.xml.content=t}}function E(){C();var t={path:U.path||"/"+U.product+"/"+U.name,confUser:U.user,confAuthor:U.author,confFrameworkType:U.frameworkType,confRemark:U.remark,isShell:"undefined"===U.frameworkType?"true":"false",confContent:e.xml.content};return t}function M(){e.newPackage&&(e.inited=!0,A="files",P())}e.productList=f,e.frameworkTypeList=[{value:"server",text:"后台server包"},{value:"undefined",text:"脚本包"}];var T=[{value:"basic",text:"基本信息"},{value:"files",text:"文件管理"},{value:"process",text:"进程"},{value:"dispatch",text:"调度&监控"},{value:"install",text:"安装/启动相关"}];e.tabList=T;var x=_.last(T).value;e.ipTypeList=[{value:"0",text:"内网"},{value:"1",text:"外网"},{value:"2",text:"全网"},{value:"3",text:"VIP"},{value:"4",text:"127.0.0.1"}],e.killSigList=["KILL","QUIT","TERM","USR1","HUP","USR2"],e.config={ip_ype:"0",kill_sig:"KILL"},e.getProduct=function(e){var t=_.findWhere(f,{product:e});return t?t.chinese:"未知"},e.getFrameworkType=function(t){var n=_.findWhere(e.frameworkTypeList,{value:t});return n?n.text:"未知"};var A=T[0].value;e.setActiveTab=function(e){A=e.value,"init"===e.value&&C()},e.isActiveTab=function(e){return A===e};var U,I=null;if(p){e.newVersion=!0,e.pkg=U=_.pick(p,["product","name","frameworkType","user","path"]),U.author=u.getUsername();var j=p.version.split(".");j.push(+j.pop()+1),U.version=j.join(".")}else g?(e.readonly=!0,I=g.exportPath,e.inited=!0,e.pkg=U=_.pick(g,["product","name","version","frameworkType","author","user","remark","path"])):(e.newPackage=!0,e.pkg=U={},U.product=t.product,U.version=h,U.author=u.getUsername(),U.user=m,U.frameworkType=v);e.hasNextStep=function(){return x!==A},e.nextStep=function(){var e;_.some(T,function(t,n){var a=t.value===A;return a&&(e=T[n+1]),a}),A=e.value},e.startCreate=function(){return e.newVersion?(e.inited=!0,void(A="files")):(e.startingCreate=!0,r.exist(U).then(function(t){d.log("PkgManager.exist",t),t.exist?(e.startingCreate=!1,l.alert({message:"包已存在！",level:"warning"})):k(U)})["catch"](function(t){e.startingCreate=!1,c("检测包是否存在失败！",t)}),!1)};var R=[],S=[];e.listPwd=function(){return R.slice(0,-1)},e.lastPwd=function(){return R[R.length-1]},e.cd=function(e){R=R.slice(0,e),w()},e.ls=w,e.svnStatus=L,e.svnRevert=function(e){e&&(e.processing=!0),o.revert(U,e.file).then(function(e){d.log("SvnManager.revert",e),L()})["catch"](function(e){c("svn还原失败！",e)})["finally"](function(){e&&(e.processing=!1)})},e.svnRevertAll=function(){function t(){n+=1,n>=e.changeList.length&&(e.svnProcessing=!1,w(),L())}if(e.changeList&&e.changeList.length){e.svnProcessing=!0;var n=0;angular.forEach(e.changeList,function(e){if("unversion"===e.action)i.rm(U,e.file).then(function(e){d.log("FileManager.rm",e)})["catch"](function(e){c("还原新增文件失败！",e)})["finally"](t);else{if(e.processing)return t();e.processing=!0,o.revert(U,e.file).then(function(e){d.log("SvnManager.revert",e)})["catch"](function(e){c("svn还原失败！",e)})["finally"](function(){e&&(e.processing=!1)})["finally"](t)}})}},e.getFileClass=function(e){switch(e.type){case"dir":return"file-icon-dir";default:return"file-icon-file"}},e.fileCanClick=function(e){return"init.xml"!==e.name||R.length},e.fileCanRemove=e.fileCanRename=e.fileCanChmod=function(t){return!t.processing&&("dir"===t.type?".."!==t.name:"init.xml"!==t.name||R.length)&&!e.readonly},e.fileCanDownload=function(e){return!e.processing&&"file"===e.type},e.clickFile=function(t){if("dir"===t.type){if(t.lsing||t.processing)return;S=R.slice(),".."===t.name?R.pop():R.push(t.name),w(t)}else e.$broadcast("edit file",{pkg:U,path:b(t.name),home:I,readonly:!!e.readonly})},e.rm=function(e){l["delete"]({message:"确认删除文件 "+e.name+" 吗？",confirm:function(){l.processing(),i.rm(U,b(e.name)).then(function(e){d.log("FileManager.rm",e),l.close(),w(),L()})["catch"](function(e){c("删除文件失败！",e)})}})},e.mkdir=function(){l.prompt({message:"请输入目录名",input:"",inputTitle:"请输入 a-z,A-Z,0-9,-,.",pattern:/^[\w\.\-]+$/,confirm:function(e){return e?"admin"!==e||b()?(l.processing(),void i.mkdir(U,b(e)).then(function(e){d.log("FileManager.mkdir",e),l.close(),w(),L()})["catch"](function(e){c("创建目录失败！",e)})):void l.alert({message:"/admin 是保留目录，请更换名称！",level:"error"}):void l.alert({message:"请输入有效的名称！",level:"error"})}})},e.rename=function(e){l.prompt({message:"请输入新的文件名",input:e.name,inputTitle:"请输入 a-z,A-Z,0-9,-,.",pattern:/^[\w\.\-]+$/,confirm:function(t){return t?(l.processing(),void i.rename(U,b(e.name),t).then(function(n){d.log("FileManager.rename",n),l.close(),e.name=t,L()})["catch"](function(e){c("修改文件名失败！",e)})):void l.alert({message:"请输入有效的名称！",level:"error"})}})},e.chmod=function(e){l.prompt({message:"请输入新的权限值",input:e.mode,inputTitle:"请输入三位八进制数字",pattern:/^[0-7]{3}$/,confirm:function(t){return name?(l.processing(),void i.chmod(U,b(e.name),t).then(function(n){d.log("FileManager.chmod",n),l.close(),e.mode=t})["catch"](function(e){c("修改文件权限失败！",e)})):void l.alert({message:"请输入有效的权限值！",level:"error"})}})},e.download=function(e){window.open(s.build(U,I)+"/raw/"+b(e.name)+(I?"?"+$.param({home:I}):""))},e.downloadTar=function(){window.open(s.build(U,!0)+"/tar")};var O="app_name port ip_type udp_port kill_sig start stop crontab clear_file substitute md5 monitor resolve link make install_on_start install_on_complete check_installation start_init start_on_started stop_on_stoped".split(" "),V="app_name port ip_type udp_port kill_sig".split(" "),F="product name user version author".split(" ");e.frameworkTypeChanged=function(){if(d.log("frameworkTypeChanged"),e.xml&&e.xml.content&&(d.log("frameworkTypeChanged inited"),"plugin"!==U.frameworkType)){var t=e.xml.content.replace(/is_shell=true\r?\n/,"");"server"!==U.frameworkType&&(t="is_shell=true\n"+t),e.xml.content=t}},e.upload=function(){e.$broadcast("upload",{path:b()})},e.pull=function(){e.$broadcast("pull",{pkg:U,path:b()})},e.save=function(){var t=E();e.saving=!0,r.save(U,t).then(function(e){d.log("PkgManager.save",e),l.alert({message:"保存配置成功！",level:"success"})})["catch"](function(e){c("保存配置失败！",e)})["finally"](function(){e.saving=!1})},e.submit=function(){if(!e.config.app_name)return A="process",void a(function(){var e=$('input[name="app_name"]').tooltip({show:!0,trigger:"manual",title:"请输入"}).tooltip("show");e.focus().select(),a(function(){e.tooltip("hide")},2e3)});var t=E();e.submitting=!0,r.submit(U,t,e.newPackage).then(function(t){d.log("PkgManager.submit",t),l.alert({message:"创建新"+(e.newPackage?"包":"版本")+"成功！",level:"success",confirm:function(){l.close(),n.go("pkg.versions",U)}})})["catch"](function(t){c("创建新"+(e.newPackage?"包":"版本")+"失败！",t)})["finally"](function(){e.submitting=!1})},(e.newVersion||e.readonly)&&(P(),M());var H;e.editRemark=function(){H=U.remark,e.toEditRemark=!0,a(function(){$("#textarea-edit-remark").focus().select()})},e.saveRemark=function(){e.editingRemark=!0,r.updateRemark(U).then(function(t){d.log("PkgManager.saveRemark",t),e.toEditRemark=!1})["catch"](function(e){c("修改版本备注失败！",e)})["finally"](function(){e.editingRemark=!1})},e.cancelEditRemark=function(){U.remark=H,e.toEditRemark=!1},e.install=function(){e.$broadcast("install",U)},e.removeVersion=function(){l["delete"]({message:"确定要删除这个版本吗？",confirm:function(){l.processing(),r.removeVersion(U).then(function(e){d.log("PkgManager.removeVersion",e),l.alert({message:"删除版本成功！",level:"success",confirm:function(){l.close(),n.go("pkg.versions",U)}})})["catch"](function(e){c("删除版本失败！",e)})}})},e.$on("need ls and svn status",function(){w(),L()})}]).controller("NewDialogsCtrl",["$scope","FileManager","HandleAjaxError","console",function(e,t,n,a){var r=$("#modal-upload"),i=$('form[name="formUpload"]');e.addAnUploadFile=function(){e.uploadFiles.push({})},e.supportMultipleFile=!0,window.pkgUploadFileDone=function(t){a.log("FileManager.upload",t),e.uploadProcessing=!1,t.result?(r.modal("hide"),e.$emit("need ls and svn status")):n("上传文件失败！",t)},e.uploadConfirm=function(){e.uploadProcessing=!0,i.submit()},e.$on("upload",function(t,n){e.uploadOptions=n,e.uploadFiles=[{}],r.modal({show:!0,backdrop:"static"})});var o=$("#modal-pull");e.$on("pull",function(r,i){e.pullOptions=i,e.pullConfirm=function(){var r=i.fileList.replace(/\r?\n/g,";");e.pullProcessing=!0,t.pull(i.pkg,i.path,i.ip,r).then(function(t){a.log("FileManager.pull",t),o.modal("hide"),e.$emit("need ls and svn status")})["catch"](function(e){n("现网拉取文件失败！",e)})["finally"](function(){e.pullProcessing=!1})},o.modal({show:!0,backdrop:"static"})})}]).controller("EditorDialogsCtrl",["$scope","FileManager","Dialog","HandleAjaxError","console",function(e,t,n,a,r){function i(n){var r=e.editorOptions,i=r.path,s=n||d[i]||p;g=s,r.content=null,e.editorLoading=!0,e.editorError=!1,t.content(r.pkg,i,s,r.home).then(function(t){var n=null===t.content||t.content===!1;n&&t.encoding!==s?(f[i]||(f[i]={}),f[i][s]=!0,f[i][t.encoding]?o():e.setCharset(t.encoding),e.editorError=!0):n?(o(),e.editorError=!0):(d[i]=s,r.content=t.content)})["catch"](function(t){e.editorError=!0,a("获取文件内容失败！",t)})["finally"](function(){e.editorLoading=!1})}function o(){n.alert({message:"读取文件失败！请确认文件编码！",level:"error"})}var s=$("#modal-editor");e.charsetList=[{value:"gbk",text:"gbk"},{value:"utf-8",text:"utf-8"}],e.languageList=[{value:null,text:"text"},{value:"clike",text:"clike"},{
value:"css",text:"css"},{value:"htmlmixed",text:"html"},{value:"javascript",text:"js"},{value:"php",text:"php"},{value:"properties",text:"ini"},{value:"shell",text:"shell"},{value:"xml",text:"xml"},{value:"yaml",text:"yaml"}];var l,c={ini:"properties",sh:"shell",xml:"xml",yaml:"yaml",php:"php",html:"htmlmixed",js:"javascript",css:"css",json:"javascript",c:"clike",h:"clike",cpp:"clike",java:"clike"},u={},d={},f={},p="gbk",g=p,m={lineWrapping:!0,lineNumbers:!0,mode:null};e.editorOpts=m,e.editorLoaded=function(e){l=e},e.setLanguage=function(t){u[e.editorOptions.path]=t,m.mode=t,l.setOption("mode",t),CodeMirror.autoLoadMode(l,t)},e.isCurrentLanguage=function(e){return m.mode===e},e.getCurrentLanguage=function(){return _.findWhere(e.languageList,{value:m.mode}).text},e.setCharset=function(e){g=e,i(e)},e.isCurrentCharset=function(e){return g===e},e.getCurrentCharset=function(){return _.findWhere(e.charsetList,{value:g}).text},e.$on("edit file",function(t,n){var a=n.path,r=a.match(/\.([^\.]+)$/),o=u[a]||r&&c[r[1]]||null;m.mode=o,l.setOption("mode",o),l.setOption("readOnly",n.readonly&&"nocursor"),CodeMirror.autoLoadMode(l,o),e.editorOptions=n,i(),s.modal({show:!0,backdrop:"static"})}),e.editorConfirm=function(){var n=e.editorOptions;e.editorProcessing=!0,t.updateContent(n.pkg,n.path,n.content||"",g).then(function(t){r.log("FileManager.updateContent",t),s.modal("hide"),e.$emit("need ls and svn status")})["catch"](function(e){a("保存文件失败！",e)})["finally"](function(){e.editorProcessing=!1})}}]).controller("InstallDialogsCtrl",["$scope","$state","$timeout","PkgManager","DeviceManager","HandleAjaxError","Utils","console",function(e,t,n,a,r,i,o,s){var l={ipList:null,startAfterComplete:0},c=$("#modal-install"),u=c.find('textarea[name="ipList"]');e.$on("install",function(n,r){e.installOptions=_.defaults({version:r.version},l),e.installConfirm=function(){var n=angular.copy(e.installOptions);if(n.ipList){var l=o.matchIps(n.ipList);l&&(n.ipList=l,e.installProcessing=!0,a.install(r,n).then(function(e){s.log("PkgManager.install",e),t.go("task-detail",{taskId:e.taskId})})["catch"](function(e){i("安装失败！",e)})["finally"](function(){e.installProcessing=!1,c.modal("hide")}))}},e.ipListChanged=function(){var t=o.matchIps(e.installOptions.ipList||"");e.ipLength=t?t.length:0},e.batchEnabled=!1,c.modal({show:!0,backdrop:"static"})});var d,f=$("#modal-devices-picker"),p=[{label:"加载中",value:null}],g=[{label:"查询失败",value:null}],m=[{label:"-- 不限 --",value:null}];e.pickDevices=function(){e.picker={business:null,idc:null},d||(e.businessList=angular.copy(p),e.idcList=angular.copy(p),r.listAttrs().then(function(t){e.businessList=angular.copy(m).concat(_.map(t.businessList,function(e){return{label:e,value:e}})),e.idcList=angular.copy(m).concat(_.map(t.idcList,function(e){return{label:e,value:e}})),d=!0})["catch"](function(){e.businessList=angular.copy(g),e.idcList=angular.copy(g)})),f.modal({show:!0,backdrop:"static"}),e.pick=function(t){e.picking=!0,r.list(angular.copy(e.picker)).then(function(a){s.log("DeviceManager.list",a);var r=_.pluck(a,"deviceId"),i=0;if("w"===t)e.installOptions.ipList=r.join("\n");else{var l=o.matchIps(e.installOptions.ipList||"")||[];i=u.val().length,e.installOptions.ipList=_.uniq(l.concat(r)).join("\n")}e.ipListChanged(),n(function(){var e=u.val().length;s.log("selectRange",i,e),u.selectRange(i,e)})})["catch"](function(e){i("筛选设备失败！",e)})["finally"](function(){e.picking=!1,f.modal("hide")})}}}]).controller("PkgCtrl",["$scope","pkg",function(e,t){e.pkg=t,e.product=t.product,e.name=t.name,e.install=function(t){e.$broadcast("install",t)}}]).controller("ProductCtrl",["$scope","$stateParams","pkgList",function(e,t,n){function a(){var t=n.slice();if(o.author&&(t=_.filter(t,function(e){return e.author===o.author})),o.name){var a=o.name;t=_.filter(t,function(e){return-1!==e.name.indexOf(a)})}"asc"===o.order&&t.reverse(),r=t,e.totalItems=t.length,o.page=1}var r,i,o={author:null,version:null,order:"desc",page:1};e.product=t.product,e.name=t.name,e.itemsPerPage=20,e.totalItems=n.length,e.filters=o,e.authorList=_.uniq(_.pluck(n,"author")).sort(),e.setAuthor=function(e){o.author=e,a()},e.setOrder=function(e){o.order=e,a()},e.nameChange=function(){a()},e.$watch("filters",function(){var t=(o.page-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.pkgList=r.slice(t,n),i?window.scrollTo(0,0):i=!0},!0),a()}]).controller("PkgVersionsCtrl",["$scope","$state","PkgUrl","PkgManager","Dialog","HandleAjaxError","console","pkg","versionList",function(e,t,n,a,r,i,o,s,l){function c(){var t=l.slice();if(f.author&&(t=_.filter(t,function(e){return e.author===f.author})),f.ignoreEmpty&&(t=_.filter(t,function(e){return e.instanceCount})),f.version){var n=f.version.replace("v","");t=_.filter(t,function(e){return 0===e.version.indexOf(n)})}"asc"===f.order&&t.reverse(),u=t,e.totalItems=t.length,f.page=1}var u,d=!1,f={author:null,ignoreEmpty:!1,version:null,order:"desc",page:1};e.filters=f,e.itemsPerPage=10,e.authorList=_.uniq(_.pluck(l,"author")).sort(),e.downloadTar=function(e){window.open(n.build(e,!0)+"/tar")},e.removeVersion=function(t){r["delete"]({message:"确定要删除这个版本吗？",confirm:function(){r.processing(),a.removeVersion(t).then(function(n){function a(e){return t.version===e.version}o.log("PkgManager.removeVersion",n),r.alert({message:"删除版本成功！",level:"success",confirm:function(){r.close()}}),l=_.reject(l,a),u=_.reject(u,a),e.versionList=_.reject(e.versionList,a)})["catch"](function(e){i("删除版本失败！",e)})}})},e.setAuthor=function(e){f.author=e,c()},e.setOrder=function(e){f.order=e,c()},e.ignoreEmptyChange=function(){c()},e.versionChange=function(){c()},e.$watch("filters",function(){var t=(f.page-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.versionList=u.slice(t,n),d?window.scrollTo(0,0):d=!0},!0),c()}]).controller("PkgSettingsCtrl",["$scope","$timeout","PkgManager","Dialog","HandleAjaxError","console","settings","pkg",function(e,t,n,a,r,i,o,s){function l(){return{visibility:s.visibility,userList:angular.copy(e.userList)}}function c(e){var t,n,a=/^\w+$/,r=[],i=_.filter(e,function(e){return e.name&&a.test(e.name)?-1!==_.indexOf(r,e.name)?n=e.name:r.push(e.name):t=!0,_.some(f,function(t,n){return e[n]})});return t?null:n?n:i}var u,d=$("#table-settings"),f={isAdmin:"admin",isSuperOperator:"super_operator",isOperator:"operator"};s.visibility=o.visibility,s.authorized=o.authorized,e.userList=o.userList,e.readonly=!0,e.edit=function(){u=l(),e.readonly=!1},e.cancel=function(){s.visibility=u.visibility,e.userList=u.userList,e.readonly=!0},e.addOne=function(){var n={unsynced:!0};angular.forEach(f,function(e,t){n[t]=!1}),e.userList.push(n),t(function(){d.find(".form-control:last").focus()})},e.remove=function(t,n){e.userList.splice(n,1)},e.save=function(){var t=l(),o=u.userList,d=c(t.userList),p="public"===t.visibility,g={},m={},v={};if(null===d)return void a.alert({message:"请输入有效的用户名！",level:"warning"});if(!angular.isArray(d))return void a.alert({message:'有重复的用户名 "'+d+'"" ！',level:"warning"});angular.forEach(f,function(e){g[e]=[],m[e]=[]}),angular.forEach(o,function(e){var t=_.findWhere(d,{name:e.name});t?angular.forEach(f,function(n,a){p&&"operator"===n||e[a]!==t[a]&&(t[a]?g[n].push(t.name):m[n].push(t.name))}):angular.forEach(f,function(t){p&&"operator"===t||m[t].push(e.name)})}),angular.forEach(d,function(e){_.findWhere(o,{name:e.name})||angular.forEach(f,function(t,n){p&&"operator"===t||e[n]&&g[t].push(e.name)})}),v.store=g,v.remove=m;var h=_.some(v,function(e){return _.some(e,function(e){return e.length})});return t.visibility!==u.visibility&&(v.visibility=t.visibility,h=!0),h?(e.storing=!0,void n.updateSettings(s,v).then(function(t){i.log("PkgManager.updateSettings",t),a.alert({message:"保存包权限设置成功！",level:"success"}),e.readonly=!0,e.userList=_.filter(e.userList,function(e){return e.unsynced=!1,_.some(f,function(t,n){return e[n]})})})["catch"](function(e){r("保存包权限设置失败！",e)})["finally"](function(){e.storing=!1})):void a.alert({message:"没有任何变更！",level:"warning"})}}]).controller("PkgInstancesCtrl",["$scope","$stateParams","$state","$timeout","Dialog","PkgManager","Utils","pkg","instanceData",function(e,t,n,a,r,i,o,s,l){function c(e){var t={};return angular.forEach(e,function(e,n){t[n]=d[n]===e?null:e}),t}function u(t){var n={frameworkType:p.frameworkType,packageUser:p.packageUser,ipList:[],installPath:null,version:null},a=!1,i=!1;if(angular.forEach(e.instanceList,function(e){e.checked&&(n.ipList.push(e.ip),n.installPath?n.installPath!==e.installPath&&(a=!0):n.installPath=e.installPath,n.version?n.version!==e.packageVersion&&(i=!0):n.version=e.packageVersion)}),!n.ipList.length)return void r.alert({message:"请至少选中一个IP",level:"warning"});switch(t){case"update":case"rollback":if(i)return void r.alert({message:"你选择的实例包含不同版本，请分开选择！",level:"warning"});case"maintenance":if(a)return void r.alert({message:"你选择的实例包含不同安装路径，请分开选择！",level:"warning"})}var o;switch(t){case"update":n.fromVersion=n.version,o=["ipList","installPath","fromVersion"];break;case"rollback":n.currentVersion=n.version,o=["ipList","installPath","currentVersion"];break;case"maintenance":o=["ipList","installPath","frameworkType","packageUser"];break;default:o=["ipList"]}return _.pick(n,o)}var d={page:1,ips:null},f=_.defaults(t,d),p=l.info;e.filters=f,e.totalItems=l.total,e.itemsPerPage=f.ips?e.totalItems:50,e.instanceList=l.instanceList,t.version&&(s.version=t.version),e.$watch("filters",function(e,t){var a=c(e);angular.equals(a,c(t))||(window.scrollTo(0,0),n.go("pkg.instances",_.defaults({},s,a)))},!0),e.filterIps=function(){var t=f.ips?f.ips.split(","):null;e.$parent.$broadcast("filter ips",t)},e.checkedAtLeastOne=!1,e.all={checked:!1},e.rowChecked=function(){var t=!0;angular.forEach(e.instanceList,function(n){n.checked?e.checkedAtLeastOne=!0:t=!1}),e.all.checked=t},e.allChecked=function(){var t=e.all.checked;angular.forEach(e.instanceList,function(e){e.checked=t}),e.checkedAtLeastOne=t},e.update=function(){var t=u("update");t&&e.$parent.$broadcast("update",t)},e.rollback=function(){var t=u("rollback");t&&e.$parent.$broadcast("rollback",t)},e.maintenance=function(t){var n=u("maintenance");n&&e.$parent.$broadcast("maintenance",t,n)},e.getIpsToCopy=function(){var e=u();return e?e.ipList.join("\n"):null},e.copied=o.copied,e.$on("$destroy",function(){delete s.version})}]).controller("PkgInstancesDialogsCtrl",["$scope","$state","$timeout","PkgManager","HandleAjaxError","console","Utils","pkg",function(e,t,n,a,r,i,o,s){var l=$("#modal-update"),c={forceUpdate:1,stopBeforeUpdate:1,restartAfterUpdate:1,updateAppName:0,updatePort:1,updateStartStopScript:1};e.$on("update",function(n,o){e.updateOptions=_.defaults(o,c),e.updateVersions=[{label:"加载中",value:null}],e.updateOptions.toVersion=null,e.getUpdateRemark=null,a.getGreaterVersionList(s.product,s.name,o.fromVersion).then(function(t){i.log("PkgManager.getGreaterVersionList",t),e.updateVersions=_.map(t,function(e){return{label:"v"+e.version,value:e.version}}),t.length?(e.updateOptions.toVersion=t[0].version,e.getUpdateRemark=function(){var n=_.findWhere(t,{version:e.updateOptions.toVersion});return n?n.remark:void 0}):e.updateVersions=[{label:"没有找到更新版本",value:null}]})["catch"](function(e){r("查询更新版本失败！",e)}),e.updateConfirm=function(){e.updateProcessing=!0,a.update(s,o).then(function(e){i.log("PkgManager.update",e),l.modal("hide"),t.go("task-detail",{taskId:e.taskId})})["catch"](function(t){e.updateProcessing=!1,r("升级失败！",t)})},e.batchEnabled=!1,l.modal({show:!0,backdrop:"static"})});var u=$("#modal-maintenance");e.$on("maintenance",function(n,o,l){e.maintenanceOperation=o,e.maintenanceOptions=l,e.maintenanceConfirm=function(){e.maintenanceProcessing=!0,a.maintenance(s,o,l).then(function(e){i.log("PkgManager.maintenance",e),u.modal("hide"),t.go("task-detail",{taskId:e.taskId})})["catch"](function(t){e.maintenanceProcessing=!1,r("操作失败！",t)})["finally"](function(){u.modal("hide")})},e.batchEnabled=!1,u.modal({show:!0,backdrop:"static"})});var d=$("#modal-rollback");e.$on("rollback",function(n,o){e.rollbackOptions=o,e.rollbackConfirm=function(){e.rollbackProcessing=!0,a.rollback(s,o).then(function(e){i.log("PkgManager.rollback",e),d.modal("hide"),t.go("task-detail",{taskId:e.taskId})})["catch"](function(t){e.rollbackProcessing=!1,r("回滚失败！",t)})["finally"](function(){d.modal("hide")})},d.modal({show:!0,backdrop:"static"})});var f=$("#modal-filter-ips"),p=f.find("textarea");e.$on("filter ips",function(a,r){e.filters={ips:r?r.join("\n"):null},e.clearFilters=function(){f.modal("hide"),t.go("pkg.instances",_.defaults({ips:null},s))},e.setFilters=function(){var n=o.matchIps(e.filters.ips);n&&(n=n.join(",")),f.modal("hide"),t.go("pkg.instances",_.defaults({ips:n},s))},f.modal({show:!0,backdrop:"static"}),n(function(){p.focus().select()})})}]).controller("DevicesCtrl",["$scope","DeviceManager","Dialog","HandleAjaxError","Utils","console","deviceList",function(e,t,n,a,r,i,o){function s(){e.businessList=_.uniq(_.map(o,"business")).sort()}function l(){e.idcList=_.uniq(_.pluck(o,"idc")).sort()}function c(e){var t=angular.copy(e);return delete t.ipText,t}function u(){var t=(m.page-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.filteredDeviceList=p.slice(t,n),e.all.checked=!1}function d(){var t=r.matchIps(m.ipText||""),n=m.business,a=m.idc,i=angular.copy(o);m.ips=t,t&&(i=_.filter(i,function(e){return _.contains(t,e.deviceId)})),null!==n&&(i=_.filter(i,function(e){return e.business===n})),null!==a&&(i=_.filter(i,function(e){return e.idc===a})),p=i,e.totalItems=i.length,m.page=1}function f(e,t){var n=_.findWhere(e,{deviceId:t.deviceId});n.business=t.business,n.idc=t.idc}var p,g,m={ipText:null,ips:null,business:null,idc:null,page:1};e.filters=m,e.itemsPerPage=50,s(),l(),e.$watch("filters",function(e,t){var n=angular.equals(c(e),c(t));n&&g||(u(),g?window.scrollTo(0,0):g=!0)},!0),e.filtersChanged=d,e.checkedAtLeastOne=!1,e.all={checked:!1},e.rowChecked=function(){var t=!0;angular.forEach(e.filteredDeviceList,function(n){n.checked?e.checkedAtLeastOne=!0:t=!1}),e.all.checked=t},e.allChecked=function(){var t=e.all.checked;angular.forEach(e.filteredDeviceList,function(e){e.checked=t}),e.checkedAtLeastOne=t},e.remove=function(r){n["delete"]({message:"确认删除设备 "+r.deviceId+" 吗？",confirm:function(){n.processing(),t.removeDevices([r.deviceId]).then(function(t){function a(e){return e.deviceId!==r.deviceId}i.log("DeviceManager.removeDevices",t),n.close(),o=_.filter(o,a),p=_.filter(p,a),e.filteredDeviceList=_.filter(e.filteredDeviceList,a),u()})["catch"](function(e){a("删除设备失败！",e)})}})},e.removeChecked=function(){var r=[];return angular.forEach(e.filteredDeviceList,function(e){e.checked&&r.push(e.deviceId)}),r.length?void n["delete"]({message:"确认删除这 "+r.length+" 台设备吗？",confirm:function(){n.processing(),t.removeDevices(r).then(function(t){function a(e){return!_.contains(r,e.deviceId)}i.log("DeviceManager.removeDevices",t),n.close(),o=_.filter(o,a),p=_.filter(p,a),e.filteredDeviceList=_.filter(e.filteredDeviceList,a),u()})["catch"](function(e){a("删除设备失败！",e)})}}):void n.alert({message:"请至少选中一台设备！",level:"warning"})},e.editChecked=function(){var t=_.where(e.filteredDeviceList,{checked:!0});return t.length?void e.$broadcast("edit devices",angular.copy(t)):void n.alert({message:"请至少选中一台设备！",level:"warning"})},e.edit=function(t){e.$broadcast("edit devices",angular.copy([t]))},e.$on("devices updated",function(t,n){angular.forEach(n,function(t){f(o,t),f(p,t),f(e.filteredDeviceList,t)}),s(),l()}),e.getIpsToCopy=function(){var t=[];return angular.forEach(e.filteredDeviceList,function(e){e.checked&&t.push(e.deviceId)}),t.join("\n")},e.copied=r.copied,d()}]).controller("DevicesDialogsCtrl",["$scope","DeviceManager","Dialog","HandleAjaxError","console",function(e,t,n,a,r){var i=$("#modal-update-devices");e.$on("edit devices",function(o,s){var l,c,u=e.formData={ips:_.pluck(s,"deviceId").join("\n")},d=s[0].idc,f=s[0].business;_.some(s.slice(1),function(e){return l||e.idc===d||(l=!0),c||e.business===f||(c=!0),l&&c}),l||(u.idc=d),c||(u.business=f),e.formData=u,i.modal({show:!0,backdrop:"static"}),e.updateConfirm=function(){return u.business||u.idc?(angular.forEach(s,function(e){u.business&&(e.business=u.business),u.idc&&(e.idc=u.idc)}),e.updating=!0,void t.importDevices(s).then(function(t){r.log("DeviceManager.importDevices",t),i.modal("hide"),e.$emit("devices updated",s)})["catch"](function(e){a("修改设备信息失败！",e)})["finally"](function(){e.updating=!1})):void n.alert({message:"没有任何变更！",level:"warning"})}})}]).controller("DevicesPasswordsCtrl",["$scope","DeviceManager","Dialog","HandleAjaxError","console",function(e,t,n,a,r){var i=/^([\d\.]+)\:(.+)$/,o={};e.formData=o,e.importDevicePassword=function(){var s=[],l=o.devices.split(/\r?\n/g),c=!0;return angular.forEach(l,function(e){if(e){var t=e.match(i);t?s.push({deviceId:t[1],password:t[2]}):c=!1}}),c&&0!==s.length?(e.importing=!0,void t.importPasswords(s).then(function(e){r.log("DeviceManager.importPasswords",e),n.alert({message:"导入设备密码成功！",level:"success"}),o.devices=null})["catch"](function(e){a("导入设备密码失败！",e)})["finally"](function(){e.importing=!1})):void n.alert({message:"请按指定格式输入IP和密码",level:"warning"})}}]).controller("DevicesImportCtrl",["$scope","DeviceManager","Dialog","HandleAjaxError","Utils","console","deviceAttrs",function(e,t,n,a,r,i,o){var s={};e.formData=s,e.businessList=o.businessList,e.idcList=o.idcList,e.importDevicePassword=function(){var o=r.matchIps(s.ips||"");if(!o)return void n.alert({message:"请输入设备 IP 列表",level:"warning"});var l=_.map(o,function(e){return{deviceId:e,idc:s.idc,business:s.business}});e.importing=!0,t.importDevices(l).then(function(e){i.log("DeviceManager.importDevices",e),n.alert({message:"导入设备列表成功！",level:"success"}),s.ips=null})["catch"](function(e){a("导入设备列表失败！",e)})["finally"](function(){e.importing=!1})}}]).controller("UsersCtrl",["$scope","UserManager","Dialog","HandleAjaxError","console","userList",function(e,t,n,a,r,i){function o(){t.list().then(function(t){e.userList=t})["catch"](function(e){a("查询用户列表失败！",e)})}var s=/^([a-zA-Z]\w{3,16})\:(.{5,16})$/,l={role:"user"},c={};e.userList=i,e.roleList=[{value:"user",text:"普通用户"},{value:"admin",text:"管理员"}],e.formData=l,e.updateData=c,e.checkedAtLeastOne=!1,e.all={checked:!1},e.rowChecked=function(){var t=!0;angular.forEach(e.userList,function(n){n.checked?e.checkedAtLeastOne=!0:t=!1}),e.all.checked=t},e.allChecked=function(){var t=e.all.checked;angular.forEach(e.userList,function(e){e.checked=t}),e.checkedAtLeastOne=t},e.storeUsers=function(){var i=[],c=l.role,u=l.users.split(/\r?\n/g),d=!0;return angular.forEach(u,function(e){if(e){var t=e.match(s);t?i.push({username:t[1],password:t[2],role:c}):d=!1}}),d&&0!==i.length?(e.storing=!0,void t.store(i).then(function(e){r.log("UserManager.store",e),n.alert({message:"添加用户成功！",level:"success"}),l.users=null,o()})["catch"](function(e){a("添加用户失败！",e)})["finally"](function(){e.storing=!1})):void n.alert({message:"请按指定格式输入用户名和密码",level:"warning"})}}]).controller("ProductManageCtrl",["$scope","PkgManager","Dialog","HandleAjaxError","console","productList",function(e,t,n,a,r,i){function o(){t.relistProducts().then(function(t){e.productList=t,e.$parent.$broadcast("relist products")})["catch"](function(e){a("查询业务列表失败！",e)})}var s=/^(\w+)\:(.+)$/,l={};e.formData=l,e.productList=i,e.checkedAtLeastOne=!1,e.all={checked:!1},e.rowChecked=function(){var t=!0;angular.forEach(e.productList,function(n){n.checked?e.checkedAtLeastOne=!0:t=!1}),e.all.checked=t},e.allChecked=function(){var t=e.all.checked;angular.forEach(e.productList,function(e){e.checked=t}),e.checkedAtLeastOne=t},e.removeCheckedProducts=function(){var i=[];angular.forEach(e.productList,function(e){e.checked&&i.push(e.product)}),i.length&&(e.removing=!0,t.removeProducts(i).then(function(e){r.log("PkgManager.removeProducts",e),n.alert({message:"删除业务成功！",level:"success"}),o()})["catch"](function(e){a("删除业务失败！",e)})["finally"](function(){e.removing=!1}))},e.removeProduct=function(e){e.removing=!0,t.removeProducts([e.product]).then(function(e){r.log("PkgManager.removeProducts",e),n.alert({message:"删除业务成功！",level:"success"}),o()})["catch"](function(e){a("删除业务失败！",e)})["finally"](function(){e.removing=!1})},e.storeProducts=function(){var i=[],c=l.products.split(/\r?\n/g),u=!0;return angular.forEach(c,function(e){if(e){var t=e.match(s);t?i.push({product:t[1],chinese:t[2]}):u=!1}}),u&&0!==i.length?(e.storing=!0,void t.storeProducts(i).then(function(e){r.log("PkgManager.storeProducts",e),n.alert({message:"添加业务成功！",level:"success"}),l.products=null,o()})["catch"](function(e){a("添加业务失败！",e)})["finally"](function(){e.storing=!1})):void n.alert({message:"请按指定格式输入ID和名称！",level:"warning"})}}]).controller("AccountCtrl",["$scope","UserManager","Me","HandleAjaxError","Dialog","console",function(e,t,n,a,r,i){var o={};e.role=n.getRole(),e.formData=o,e.updatePassword=function(){return o.password!==o.password2?(r.alert({message:"两次输入的密码不一致！",level:"warning"}),!1):(e.updatingPassword=!0,void t.update(_.pick(o,"old_password","password")).then(function(e){i.log("UserManager.update",e),r.alert({message:"修改密码成功！",level:"success"}),o.old_password=o.password=o.password2=null})["catch"](function(e){a("修改密码失败！",e)})["finally"](function(){e.updatingPassword=!1}))}}]);